<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Enrollment Details - ETMS</title>
</head>
<body>
<div layout:fragment="content">
    <!-- Breadcrumb -->
    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 mb-6">
        <a th:href="@{/learner/enrollments}" class="hover:underline">My Enrollments</a>
        <i class="fas fa-chevron-right mx-2"></i>
        <span th:text="${enrollment.courseTitle}">Course Title</span>
    </div>
    
    <!-- Course Header -->
    <div class="bg-gradient-to-r from-primary-600 to-primary-800 dark:from-primary-700 dark:to-primary-900 rounded-lg shadow-xl p-8 mb-8 text-white">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
            <div class="flex-1">
                <h1 class="text-4xl font-bold mb-4" th:text="${enrollment.courseTitle}">
                    Java Spring Boot Fundamentals
                </h1>
                
                <!-- Status Badge -->
                <div class="inline-flex items-center gap-2 mb-4">
                    <span th:class="${enrollment.status.toString() == 'ACTIVE' ? 'bg-green-500' : 
                                     enrollment.status.toString() == 'COMPLETED' ? 'bg-blue-500' : 'bg-gray-500'}"
                          class="px-3 py-1 text-white text-sm font-semibold rounded-full">
                        <i th:class="${enrollment.status.toString() == 'COMPLETED' ? 'fas fa-check-circle' : 'fas fa-clock'}" class="mr-1"></i>
                        <span th:text="${enrollment.status}">ACTIVE</span>
                    </span>
                    
                    <span th:if="${enrollment.certificateIssued}" class="px-3 py-1 bg-yellow-500 text-white text-sm font-semibold rounded-full">
                        <i class="fas fa-certificate mr-1"></i>Certificate Earned
                    </span>
                </div>
                
                <!-- Enrollment Info -->
                <div class="flex flex-wrap gap-6 text-sm text-primary-100">
                    <div>
                        <i class="fas fa-calendar mr-1"></i>
                        Enrolled: <span th:text="${#temporals.format(enrollment.enrolledAt, 'MMM dd, yyyy')}">Oct 10, 2025</span>
                    </div>
                    
                    <div th:if="${enrollment.lastAccessed != null}">
                        <i class="fas fa-clock mr-1"></i>
                        Last accessed: <span th:text="${#temporals.format(enrollment.lastAccessed, 'MMM dd, yyyy')}">Oct 12, 2025</span>
                    </div>
                    
                    <div th:if="${enrollment.completionDate != null}">
                        <i class="fas fa-trophy mr-1"></i>
                        Completed: <span th:text="${#temporals.format(enrollment.completionDate, 'MMM dd, yyyy')}">Oct 15, 2025</span>
                    </div>
                </div>
            </div>
            
            <!-- Progress Card -->
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 min-w-[250px]">
                <div class="text-center mb-4">
                    <div class="text-5xl font-bold mb-2" 
                         th:text="${enrollment.progressPercent != null ? #numbers.formatDecimal(enrollment.progressPercent, 1, 0) + '%' : '0%'}">
                        75%
                    </div>
                    <p class="text-primary-100">Overall Progress</p>
                </div>
                
                <div class="w-full bg-white/20 rounded-full h-4 mb-4">
                    <div class="bg-white h-4 rounded-full progress-bar-fill" 
                         th:style="'width: ' + ${enrollment.progressPercent ?: 0} + '%'"></div>
                </div>
                
                <div class="text-center text-sm">
                    <div>
                        <p class="text-primary-100">Materials</p>
                        <p class="font-bold" data-materials-count>
                            <span th:text="${enrollment.completedMaterials ?: 0}">5</span>/<span th:text="${enrollment.totalMaterials ?: 0}">10</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mb-8">
        <a th:href="@{/courses/{id}(id=${enrollment.courseId})}" 
           class="px-6 py-3 bg-primary-600 hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-600 text-white font-semibold rounded-lg transition">
            <i class="fas fa-info-circle mr-2"></i>View Course Details
        </a>
        
        <a th:href="@{/learner/courses/{id}/feedback(id=${enrollment.courseId})}" 
           class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition">
            <i class="fas fa-star mr-2"></i>Rate Course
        </a>
        
        <a th:if="${enrollment.certificateIssued and enrollment.certificateUrl != null}" 
           th:href="${enrollment.certificateUrl}" 
           target="_blank"
           class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg transition">
            <i class="fas fa-download mr-2"></i>Download Certificate
        </a>
        
        <form th:if="${enrollment.status.toString() == 'ACTIVE'}"
              th:action="@{/learner/enrollments/{id}/cancel(id=${enrollment.id})}" 
              method="post"
              onsubmit="return confirm('Are you sure you want to cancel this enrollment?')">
            <button type="submit" 
                    class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                <i class="fas fa-times-circle mr-2"></i>Cancel Enrollment
            </button>
        </form>
    </div>
    
    <!-- Notes Section -->
    <div th:if="${enrollment.notes != null and !#strings.isEmpty(enrollment.notes)}" 
         class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-6 rounded-lg mb-8">
        <h3 class="text-lg font-semibold text-yellow-900 dark:text-yellow-300 mb-2">
            <i class="fas fa-sticky-note mr-2"></i>Your Notes
        </h3>
        <p class="text-yellow-800 dark:text-yellow-200" th:text="${enrollment.notes}">
            Course notes will appear here
        </p>
    </div>
    
    <!-- Course Content Section (Sections or Materials) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
            <i class="fas fa-layer-group mr-2"></i>Course Content
            <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2" 
                  th:if="${!#lists.isEmpty(sections)}">
                (<span th:text="${#lists.size(sections)}">0</span> sections)
            </span>
        </h2>
        
        <!-- Sections Accordion (if sections exist) -->
        <div th:if="${!#lists.isEmpty(sections)}" class="space-y-3">
            <div th:each="section, iterStat : ${sections}" 
                 class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden section-item">
                
                <!-- Section Header (Clickable) -->
                <div class="section-header bg-gray-50 dark:bg-gray-700 p-5 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition"
                     th:attr="data-section-id=${section.id}"
                     onclick="toggleSection(this)">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 flex-1">
                            <!-- Toggle Icon -->
                            <i class="fas fa-chevron-down section-icon text-gray-500 dark:text-gray-400 transition-transform"></i>
                            
                            <!-- Section Info -->
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-1">
                                    <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">
                                        Section <span th:text="${iterStat.count}">1</span>
                                    </span>
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white" th:text="${section.title}">
                                        Introduction
                                    </h3>
                                </div>
                                
                                <p th:if="${section.description != null and !#strings.isEmpty(section.description)}"
                                   class="text-sm text-gray-600 dark:text-gray-400 mb-2"
                                   th:text="${section.description}">
                                    Section description
                                </p>
                                
                                <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span>
                                        <i class="fas fa-file mr-1"></i>
                                        <span th:text="${section.totalMaterials ?: 0}">0</span> materials
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section Content (Materials) - Initially Hidden -->
                <div class="section-content hidden">
                    <div th:if="${!#lists.isEmpty(section.materials)}" class="p-4 space-y-2 bg-white dark:bg-gray-800">
                        <div th:each="material : ${section.materials}" 
                             class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                            
                            <div class="flex items-center gap-4 flex-1">
                                <!-- Material Type Icon -->
                                <div th:switch="${material.materialType.toString()}" class="flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center">
                                    <div th:case="'VIDEO'" class="bg-red-100 dark:bg-red-900/30 w-full h-full rounded-lg flex items-center justify-center">
                                        <i class="fas fa-play text-red-600 dark:text-red-400"></i>
                                    </div>
                                    <div th:case="'PDF'" class="bg-red-100 dark:bg-red-900/30 w-full h-full rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-pdf text-red-600 dark:text-red-400"></i>
                                    </div>
                                    <div th:case="'AUDIO'" class="bg-purple-100 dark:bg-purple-900/30 w-full h-full rounded-lg flex items-center justify-center">
                                        <i class="fas fa-volume-up text-purple-600 dark:text-purple-400"></i>
                                    </div>
                                    <div th:case="'IMAGE'" class="bg-green-100 dark:bg-green-900/30 w-full h-full rounded-lg flex items-center justify-center">
                                        <i class="fas fa-image text-green-600 dark:text-green-400"></i>
                                    </div>
                                    <div th:case="*" class="bg-blue-100 dark:bg-blue-900/30 w-full h-full rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                </div>
                                
                                <!-- Material Info -->
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-gray-900 dark:text-white mb-1"
                                        th:text="${material.originalFilename}">
                                        Material Title
                                    </h4>
                                    
                                    <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                                        <span th:text="${material.materialType}">VIDEO</span>
                                        <span th:if="${material.durationSeconds != null}">
                                            <i class="fas fa-clock mr-1"></i>
                                            <span th:text="${#numbers.formatDecimal(material.durationSeconds / 60, 1, 0)} + ' min'">5 min</span>
                                        </span>
                                        <span th:if="${material.isRequired}"
                                              class="px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-400 rounded font-semibold">
                                            <i class="fas fa-star mr-1"></i>Required
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Button -->
                            <div class="flex items-center gap-3">
                                <!-- Video Play Button -->
                                <button th:if="${material.materialType.toString() == 'VIDEO'}"
                                        th:data-material-id="${material.id}"
                                        onclick="toggleVideoPlayer(this.dataset.materialId)"
                                        class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition">
                                    <i class="fas fa-play mr-1"></i>
                                    <span>Watch</span>
                                </button>
                                
                                <!-- Non-Video: Open Button + Completion Checkbox -->
                                <div th:if="${material.materialType.toString() != 'VIDEO'}" class="flex items-center gap-3">
                                    <a th:href="@{/learner/materials/{id}/view(id=${material.id})}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition">
                                        <i class="fas fa-external-link-alt mr-1"></i>
                                        <span>Open</span>
                                    </a>
                                    
                                    <!-- Mark as Complete Checkbox (hidden initially, shown by JS if not completed) -->
                                    <label class="flex items-center gap-2 cursor-pointer group" 
                                           th:id="'completion-label-' + ${material.id}"
                                           th:data-material-id="${material.id}">
                                        <input type="checkbox"
                                               th:id="'complete-' + ${material.id}"
                                               th:data-material-id="${material.id}"
                                               th:data-enrollment-id="${enrollment.id}"
                                               onchange="markMaterialComplete(this)"
                                               class="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2 cursor-pointer">
                                        <span class="text-sm text-gray-600 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-gray-200">
                                            Mark complete
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Empty Section Message -->
                    <div th:if="${#lists.isEmpty(section.materials)}" 
                         class="p-6 text-center text-gray-500 dark:text-gray-400 text-sm">
                        <i class="fas fa-info-circle mr-1"></i>
                        No materials in this section yet
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fallback: Show flat materials list if no sections -->
        <div th:if="${#lists.isEmpty(sections)}" class="space-y-4">
            <div th:if="${#lists.isEmpty(materials)}" class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 text-center">
                <i class="fas fa-info-circle text-4xl text-gray-400 mb-3"></i>
                <p class="text-gray-600 dark:text-gray-400">
                    No materials available for this course yet
                </p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">
                    Check back later or contact the instructor
                </p>
            </div>
            
            <div th:if="${!#lists.isEmpty(materials)}" class="grid gap-4">
                <div th:each="material : ${materials}" 
                     class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4 flex-1">
                            <!-- Material Type Icon -->
                            <div class="flex-shrink-0">
                                <div th:switch="${material.materialType}" 
                                     class="w-12 h-12 rounded-lg flex items-center justify-center text-white">
                                    <i th:case="'VIDEO'" class="fas fa-play text-2xl bg-red-500"></i>
                                    <i th:case="'PDF'" class="fas fa-file-pdf text-2xl bg-red-600"></i>
                                    <i th:case="'DOCUMENT'" class="fas fa-file-alt text-2xl bg-blue-500"></i>
                                    <i th:case="'PRESENTATION'" class="fas fa-presentation text-2xl bg-orange-500"></i>
                                    <i th:case="'AUDIO'" class="fas fa-music text-2xl bg-purple-500"></i>
                                    <i th:case="'IMAGE'" class="fas fa-image text-2xl bg-green-500"></i>
                                    <i th:case="'CODE_SAMPLE'" class="fas fa-code text-2xl bg-gray-600"></i>
                                    <i th:case="'EXERCISE'" class="fas fa-dumbbell text-2xl bg-yellow-500"></i>
                                    <i th:case="'QUIZ'" class="fas fa-question-circle text-2xl bg-indigo-500"></i>
                                    <i th:case="'CERTIFICATE'" class="fas fa-certificate text-2xl bg-yellow-600"></i>
                                    <i th:case="*" class="fas fa-file text-2xl bg-gray-500"></i>
                                </div>
                            </div>
                            
                            <!-- Material Info -->
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2" 
                                    th:text="${material.originalFilename}">Material Title</h3>
                                
                                <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    <span class="flex items-center">
                                        <i class="fas fa-tag mr-1"></i>
                                        <span th:text="${material.materialType}">PDF</span>
                                    </span>
                                    
                                    <span class="flex items-center" th:if="${material.fileSize != null}">
                                        <i class="fas fa-weight mr-1"></i>
                                        <span th:text="${#numbers.formatDecimal(material.fileSize / 1024 / 1024, 1, 1)} + ' MB'">2.5 MB</span>
                                    </span>
                                    
                                    <span class="flex items-center" th:if="${material.durationSeconds != null}">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span th:text="${#numbers.formatDecimal(material.durationSeconds / 60, 1, 0)} + ' min'">15 min</span>
                                    </span>
                                    
                                    <span class="flex items-center" th:if="${material.isRequired}">
                                        <i class="fas fa-star mr-1 text-yellow-500"></i>
                                        <span class="text-yellow-600 dark:text-yellow-400 font-medium">Required</span>
                                    </span>
                                </div>
                                
                                <p th:if="${material.description != null and !#strings.isEmpty(material.description)}" 
                                   class="text-gray-600 dark:text-gray-400 text-sm mb-3" 
                                   th:text="${material.description}">Material description</p>
                                
                                <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-500">
                                    <span class="flex items-center">
                                        <i class="fas fa-eye mr-1"></i>
                                        <span th:text="${material.viewCount}">0</span> views
                                    </span>
                                    
                                    <span class="flex items-center">
                                        <i class="fas fa-calendar mr-1"></i>
                                        <span th:text="${#temporals.format(material.uploadedAt, 'MMM dd, yyyy')}">Oct 10, 2025</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col md:flex-row items-end md:items-center gap-3">
                            <!-- Video Player Toggle Button -->
                            <button th:if="${material.materialType.toString() == 'VIDEO'}" 
                                    th:data-material-id="${material.id}"
                                    onclick="toggleVideoPlayer(this.dataset.materialId)"
                                    class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition">
                                <i class="fas fa-play mr-1"></i>
                                <span>Watch Video</span>
                            </button>
                            
                            <!-- Non-Video: Open Button + Completion Checkbox -->
                            <div th:if="${material.materialType.toString() != 'VIDEO'}" class="flex items-center gap-3">
                                <a th:href="@{/learner/materials/{id}/view(id=${material.id})}" 
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition">
                                    <i class="fas fa-external-link-alt mr-1"></i>
                                    <span>Open</span>
                                </a>
                                
                                <!-- Mark as Complete Checkbox (hidden initially, shown by JS if not completed) -->
                                <label class="flex items-center gap-2 cursor-pointer group" 
                                       th:id="'completion-label-' + ${material.id}"
                                       th:data-material-id="${material.id}">
                                    <input type="checkbox"
                                           th:id="'complete-' + ${material.id}"
                                           th:data-material-id="${material.id}"
                                           th:data-enrollment-id="${enrollment.id}"
                                           onchange="markMaterialComplete(this)"
                                           class="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2 cursor-pointer">
                                    <span class="text-sm text-gray-600 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-gray-200">
                                        Mark complete
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Video Player Modal -->
    <div id="videoPlayerModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 id="videoTitle" class="text-lg font-semibold text-gray-900 dark:text-white">
                            Video Player
                        </h3>
                        <button onclick="closeVideoPlayer()" 
                                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-4">
                    <!-- Video Player -->
                    <div class="relative">
                        <video id="videoPlayer" 
                               controls 
                               controlslist="nodownload"
                               disablepictureinpicture
                               width="100%" 
                               class="rounded-lg"
                               ontimeupdate="updateVideoProgress()"
                               onended="onVideoEnded()"
                               onseeking="onVideoSeeking()"
                               onseeked="onVideoSeeked()"
                               onpause="onVideoPause()"
                               onplay="onVideoPlay()"
                               oncontextmenu="return false;">
                            Your browser does not support the video tag.
                        </video>
                        
                        <!-- Progress Bar -->
                        <div class="mt-4">
                            <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400 mb-2">
                                <span>Progress: <span id="progressText">0%</span></span>
                                <span>Time: <span id="timeText">0:00 / 0:00</span></span>
                                <span id="skipCounter" class="text-xs">
                                    <i class="fas fa-forward mr-1"></i>
                                    Skips: <span id="skipCount">0</span>/3
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div id="progressBar" class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Anti-cheating warnings -->
                        <div id="warningMessage" class="hidden mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 mr-2"></i>
                                <span class="text-yellow-800 dark:text-yellow-200 text-sm">
                                    <span id="warningText">Please watch the video properly to mark it as completed.</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// Video tracking variables
let currentMaterialId = null;
let videoProgress = {
    lastPosition: 0,
    seekCount: 0,
    totalSeekTime: 0,
    watchTime: 0,
    startTime: null,
    isPaused: false,
    suspiciousActivity: false,
    isCompleted: false,  // Track completion explicitly
    lastUpdateTime: null,  // Track last update for accurate time calculation
    toastShown: false  // Prevent duplicate toast notifications
};

// Section accordion toggle
function toggleSection(headerElement) {
    const sectionItem = headerElement.closest('.section-item');
    const sectionContent = sectionItem.querySelector('.section-content');
    const icon = headerElement.querySelector('.section-icon');
    
    // Toggle content visibility
    if (sectionContent.classList.contains('hidden')) {
        sectionContent.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
    } else {
        sectionContent.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
}

// Initialize video player
function toggleVideoPlayer(materialId) {
    console.log('üé¨ Opening video player for material:', materialId);
    currentMaterialId = materialId;
    const video = document.getElementById('videoPlayer');
    const modal = document.getElementById('videoPlayerModal');
    const videoTitle = document.getElementById('videoTitle');
    
    // Set video source
    video.src = `/learner/materials/${materialId}/view`;
    videoTitle.textContent = 'Loading video...';
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Reset progress tracking
    resetVideoProgress();
    
    // Load material progress from server
    loadMaterialProgress(materialId);
    
    // Add error handler
    video.onerror = function(e) {
        // Only show error if it's not during close/cleanup
        if (currentMaterialId) {
            console.error('‚ùå Video load error:', e);
            showError('Failed to load video. Please try again.');
        }
    };
    
    // Add loaded handler
    video.onloadeddata = function() {
        console.log('‚úÖ Video loaded successfully - Duration:', Math.round(video.duration), 'seconds');
        videoTitle.textContent = 'Video Player';
        
        // Show helpful message about completion requirements
        const infoMessage = document.createElement('div');
        infoMessage.className = 'mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg';
        infoMessage.innerHTML = `
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mr-2 mt-1"></i>
                <div class="text-blue-800 dark:text-blue-200 text-sm">
                    <p class="font-semibold mb-1">To complete this video:</p>
                    <ul class="list-disc list-inside space-y-1 ml-2">
                        <li>Watch at least 30% of the video content</li>
                        <li>Avoid excessive skipping (max 3 skips allowed)</li>
                        <li>Your progress is saved automatically</li>
                    </ul>
                </div>
            </div>
        `;
        
        // Insert after progress bar
        const progressContainer = document.querySelector('#videoPlayerModal .relative');
        if (progressContainer && !document.querySelector('.video-info-message')) {
            infoMessage.classList.add('video-info-message');
            progressContainer.appendChild(infoMessage);
            
            // Remove after 10 seconds
            setTimeout(() => {
                infoMessage.remove();
            }, 10000);
        }
    };
    
    // Debug: Log when video starts playing
    video.onloadedmetadata = function() {
        console.log('üìä Video metadata loaded - Duration:', Math.round(video.duration), 'seconds');
    };
}

// Close video player
function closeVideoPlayer() {
    const modal = document.getElementById('videoPlayerModal');
    const video = document.getElementById('videoPlayer');
    
    // Save progress before closing (only if video was actually playing)
    if (currentMaterialId && video.duration && !isNaN(video.duration)) {
        saveVideoProgress();
    }
    
    // Remove error handler to prevent error on close
    video.onerror = null;
    
    // Pause and reset
    video.pause();
    video.removeAttribute('src'); // Remove the source
    video.load(); // Reset video element
    
    // Hide modal
    modal.classList.add('hidden');
    currentMaterialId = null;
    resetVideoProgress();
}

// Reset video progress tracking
function resetVideoProgress() {
    videoProgress = {
        lastPosition: 0,
        seekCount: 0,
        totalSeekTime: 0,
        watchTime: 0,
        startTime: null,
        isPaused: false,
        suspiciousActivity: false,
        isCompleted: false,
        lastUpdateTime: null,  // Track last update for accurate time calculation
        toastShown: false  // Reset toast flag
    };
    updateProgressDisplay();
}

// Load material progress from server
async function loadMaterialProgress(materialId) {
    try {
        const response = await fetch(`/learner/materials/${materialId}/progress`);
        if (response.ok) {
            const progress = await response.json();
            videoProgress.lastPosition = progress.lastPositionSeconds || 0;
            
            // Check if video was already completed
            if (progress.isCompleted) {
                videoProgress.isCompleted = true;
                console.log('‚úÖ This video was previously completed - Free navigation enabled');
                
                // Show info message
                showSuccess('‚úÖ Video already completed! You can navigate freely.');
                
                // Add completed badge to video title
                const videoTitle = document.getElementById('videoTitle');
                if (videoTitle && !videoTitle.querySelector('.completed-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'completed-badge ml-3 px-3 py-1 bg-green-500 text-white text-sm rounded-full';
                    badge.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Completed';
                    videoTitle.appendChild(badge);
                }
                
                // Hide skip counter (not needed for completed videos)
                const skipCounter = document.getElementById('skipCounter');
                if (skipCounter) {
                    skipCounter.style.display = 'none';
                }
            }
            
            // Set video to last position
            const video = document.getElementById('videoPlayer');
            video.addEventListener('loadedmetadata', function() {
                video.currentTime = videoProgress.lastPosition;
                updateProgressDisplay();
            });
        }
    } catch (error) {
        console.log('No previous progress found');
    }
}

// Update video progress
function updateVideoProgress() {
    const video = document.getElementById('videoPlayer');
    if (!video.duration) return;
    
    const currentTime = video.currentTime;
    const duration = video.duration;
    const progressPercent = (currentTime / duration) * 100;
    
    // Update display
    document.getElementById('progressText').textContent = Math.round(progressPercent) + '%';
    document.getElementById('progressBar').style.width = progressPercent + '%';
    
    // Update time display
    const currentMinutes = Math.floor(currentTime / 60);
    const currentSeconds = Math.floor(currentTime % 60);
    const durationMinutes = Math.floor(duration / 60);
    const durationSeconds = Math.floor(duration % 60);
    
    document.getElementById('timeText').textContent = 
        `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
    
    // Track watch time more accurately using actual time delta
    if (!video.paused) {
        const now = Date.now();
        if (videoProgress.lastUpdateTime && videoProgress.lastUpdateTime > 0) {
            const timeDelta = (now - videoProgress.lastUpdateTime) / 1000; // Convert to seconds
            // Only add time if delta is reasonable (< 2 seconds to filter out pauses/seeks)
            if (timeDelta > 0 && timeDelta < 2) {
                videoProgress.watchTime += timeDelta;
                console.log('‚è±Ô∏è Tracking: +' + timeDelta.toFixed(2) + 's, Total watch time:', Math.round(videoProgress.watchTime) + 's');
            }
        }
        videoProgress.lastUpdateTime = now;
    }
    
    // Save progress every 30 seconds
    if (Math.floor(currentTime) % 30 === 0 && Math.floor(currentTime) > 0) {
        saveVideoProgress();
    }
}

// Handle video seeking (anti-cheating)
function onVideoSeeking() {
    const video = document.getElementById('videoPlayer');
    const seekDistance = Math.abs(video.currentTime - videoProgress.lastPosition);
    
    // ‚≠ê DEMO MODE: Anti-cheating disabled for prototype presentation
    // Allow free navigation at all times
    console.log('‚úÖ DEMO MODE: Anti-cheating disabled - Free navigation allowed');
    videoProgress.lastPosition = video.currentTime;
    return; // Skip all anti-cheating checks
    
    // [CODE BELOW IS DISABLED IN DEMO MODE]
    
    // Allow free navigation if video is already completed
    if (videoProgress.isCompleted) {
        console.log('‚úÖ Video already completed - Free navigation allowed');
        return; // Skip all anti-cheating checks
    }
    
    // Detect forward seeking (skipping ahead)
    if (video.currentTime > videoProgress.lastPosition && seekDistance > 10) {
        videoProgress.seekCount++;
        videoProgress.totalSeekTime += seekDistance;
        
        console.log('‚è© Forward skip detected:', Math.round(seekDistance), 'seconds (Total skips:', videoProgress.seekCount + ')');
        
        // Update skip counter display
        const skipCountEl = document.getElementById('skipCount');
        const skipCounterEl = document.getElementById('skipCounter');
        if (skipCountEl) {
            // Show "3+" if more than 3 skips
            skipCountEl.textContent = videoProgress.seekCount > 3 ? '3+' : videoProgress.seekCount;
            
            // Change color based on skip count
            if (videoProgress.seekCount >= 3) {
                skipCounterEl.className = 'text-xs text-red-600 dark:text-red-400 font-semibold';
            } else if (videoProgress.seekCount >= 2) {
                skipCounterEl.className = 'text-xs text-orange-600 dark:text-orange-400 font-semibold';
            } else {
                skipCounterEl.className = 'text-xs text-yellow-600 dark:text-yellow-400';
            }
        }
        
        // Progressive warnings
        if (videoProgress.seekCount === 1) {
            showWarning('‚ö†Ô∏è Skipping detected. Watch the full video to get credit.', 'warning');
        } else if (videoProgress.seekCount === 2) {
            showWarning('‚ö†Ô∏è Multiple skips detected. This may prevent course completion.', 'warning');
        } else if (videoProgress.seekCount === 3) {
            showWarning('üö´ Too many skips! Video will NOT count as completed.', 'error');
            videoProgress.suspiciousActivity = true;
        } else if (videoProgress.seekCount >= 4) {
            // BLOCK further seeking - reset to last valid position
            video.currentTime = videoProgress.lastPosition;
            
            // Show toast notification explaining why seeking is blocked (only once)
            if (!videoProgress.toastShown) {
                showToast(
                    'Fast-Forwarding Restricted', 
                    'Skipping ahead is disabled to ensure full course participation.',
                    'error'
                );
                videoProgress.toastShown = true;  // Mark toast as shown
            }
            
            return; // Don't update lastPosition since we blocked the seek
        }
    }
}

// Handle video seeked
function onVideoSeeked() {
    const video = document.getElementById('videoPlayer');
    videoProgress.lastPosition = video.currentTime;
}

// Handle video pause
function onVideoPause() {
    videoProgress.isPaused = true;
    saveVideoProgress();
}

// Handle video play
function onVideoPlay() {
    videoProgress.isPaused = false;
    videoProgress.lastUpdateTime = Date.now();  // Reset time tracking on play
    if (!videoProgress.startTime) {
        videoProgress.startTime = new Date();
    }
    console.log('‚ñ∂Ô∏è Video playing - Watch time tracking started');
}

// Handle video ended
function onVideoEnded() {
    const video = document.getElementById('videoPlayer');
    const duration = video.duration;
    const watchPercentage = (videoProgress.watchTime / duration) * 100;
    
    console.log('üèÅ Video ended!');
    console.log('üìä Watch percentage:', Math.round(watchPercentage) + '%');
    console.log('‚è±Ô∏è Watch time:', Math.round(videoProgress.watchTime), 'seconds out of', Math.round(duration), 'seconds');
    console.log('‚è© Seek count:', videoProgress.seekCount);
    console.log('üîç Validating completion...');
    
    // Validate completion
    const isValid = validateVideoCompletion(watchPercentage);
    console.log('‚úì Validation result:', isValid);
    
    if (isValid) {
        videoProgress.isCompleted = true;  // Set completion flag
        console.log('üéâ Video marked as COMPLETED!');
        markVideoAsCompleted();
    } else {
        showWarning('Please watch more of the video to mark it as completed.');
        console.log('‚ö†Ô∏è Video not completed - insufficient watch time (need 60-80% minimum)');
    }
    
    // Save progress immediately with completion status
    console.log('üíæ Saving final progress with isCompleted:', videoProgress.isCompleted);
    saveVideoProgress();
}

// Validate video completion
function validateVideoCompletion(watchPercentage) {
    // ‚≠ê DEMO MODE: Disabled for prototype presentation
    // Always validates video completion regardless of watch time or seeking
    console.log('‚úÖ DEMO MODE: Video validation bypassed');
    console.log('   - Watch percentage:', Math.round(watchPercentage) + '%');
    console.log('   - Validation: ALWAYS TRUE (Demo Mode)');
    
    return true;  // Always validate for demo/testing purposes
}

// Mark video as completed
function markVideoAsCompleted() {
    console.log('üé¨ markVideoAsCompleted() called');
    console.log('üìä videoProgress.isCompleted:', videoProgress.isCompleted);
    
    showSuccess('Video completed! Great job!');
    
    // Save the final progress with completion status
    saveVideoProgress().then(() => {
        console.log('üíæ Video progress saved, now updating enrollment progress');
        // Update progress dynamically without page reload
        updateEnrollmentProgress();
    });
}

// Mark non-video material as complete (toggle behavior)
async function markMaterialComplete(checkbox) {
    const materialId = checkbox.dataset.materialId;
    const enrollmentId = checkbox.dataset.enrollmentId;
    const isCompleted = checkbox.checked;
    
    console.log('üîç Checkbox toggled:', {
        materialId,
        enrollmentId,
        checked: isCompleted
    });
    
    // Disable checkbox during request
    checkbox.disabled = true;
    
    try {
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        
        const response = await fetch('/learner/materials/progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                materialId: materialId,
                isCompleted: isCompleted,
                completionPercent: isCompleted ? 100.0 : 0.0,
                timeSpentMinutes: 0,
                lastPositionSeconds: 0
            })
        });
        
        if (response.ok) {
            if (isCompleted) {
                showSuccess('Material marked as complete!');
            } else {
                showToast('Material marked as incomplete', 'info');
            }
            
            // Update progress dynamically
            updateEnrollmentProgress();
        } else {
            // Get error details from response
            const errorText = await response.text();
            console.error('‚ùå Backend error:', response.status, errorText);
            throw new Error(`Failed to update material status: ${response.status} - ${errorText.substring(0, 100)}`);
        }
    } catch (error) {
        console.error('Error updating material status:', error);
        showError('Failed to update material status. Please try again.');
        // Revert checkbox state on error
        checkbox.checked = !isCompleted;
    } finally {
        // Re-enable checkbox
        checkbox.disabled = false;
    }
}

// Show warning message
function showWarning(message, severity = 'warning') {
    const warningDiv = document.getElementById('warningMessage');
    const warningText = document.getElementById('warningText');
    warningText.textContent = message;
    
    // Update styling based on severity
    if (severity === 'error') {
        warningDiv.className = 'mt-3 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg';
        warningDiv.querySelector('.fas').className = 'fas fa-ban text-red-600 dark:text-red-400 mr-2';
        warningDiv.querySelector('span').className = 'text-red-800 dark:text-red-200 text-sm font-semibold';
    } else {
        warningDiv.className = 'mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg';
        warningDiv.querySelector('.fas').className = 'fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 mr-2';
        warningDiv.querySelector('span').className = 'text-yellow-800 dark:text-yellow-200 text-sm';
    }
    
    warningDiv.classList.remove('hidden');
    
    // Hide after 5 seconds (longer for errors)
    const hideDelay = severity === 'error' ? 8000 : 5000;
    setTimeout(() => {
        warningDiv.classList.add('hidden');
    }, hideDelay);
}

// Show success message
function showSuccess(message) {
    console.log(message);
    
    // Create success notification
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-[9999] animate-fade-in';
    successDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-check-circle text-2xl mr-3"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(successDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}

// Show error message
function showError(message) {
    console.error(message);
    
    // Create error notification
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-[9999] animate-fade-in';
    errorDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-2xl mr-3"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(errorDiv);
    
    // Remove after 5 seconds
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

// Show toast notification (for more detailed messages)
function showToast(title, message, type = 'info') {
    console.log(`[${type.toUpperCase()}]`, title, '-', message);
    console.log('Creating toast notification...');
    
    // Determine styling based on type
    let bgColor, iconClass, icon;
    if (type === 'error') {
        bgColor = 'bg-red-600';
        iconClass = 'fas fa-ban';
        icon = 'üö´';
    } else if (type === 'warning') {
        bgColor = 'bg-yellow-600';
        iconClass = 'fas fa-exclamation-triangle';
        icon = '‚ö†Ô∏è';
    } else if (type === 'success') {
        bgColor = 'bg-green-600';
        iconClass = 'fas fa-check-circle';
        icon = '‚úÖ';
    } else {
        bgColor = 'bg-blue-600';
        iconClass = 'fas fa-info-circle';
        icon = '‚ÑπÔ∏è';
    }
    
    // Create toast notification
    const toastDiv = document.createElement('div');
    toastDiv.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-5 rounded-lg shadow-2xl z-[9999] toast-notification animate-fade-in border-l-4 border-white`;
    toastDiv.innerHTML = `
        <div class="flex items-start">
            <i class="${iconClass} text-3xl mr-4 mt-1"></i>
            <div class="flex-1">
                <h3 class="font-bold text-lg mb-1">${title}</h3>
                <p class="text-sm text-white/90">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white/80 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(toastDiv);
    console.log('Toast notification added to DOM:', toastDiv);
    
    // Remove after 10 seconds (longer for important messages)
    setTimeout(() => {
        if (toastDiv.parentElement) {
            toastDiv.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => toastDiv.remove(), 500);
        }
    }, 10000);
}

// Show toast notification with action button
function showToastWithAction(title, message, type = 'info', actionLabel, actionCallback) {
    console.log(`[${type.toUpperCase()}]`, title, '-', message);
    
    // Determine styling based on type
    let bgColor, iconClass;
    if (type === 'error') {
        bgColor = 'bg-red-600';
        iconClass = 'fas fa-ban';
    } else if (type === 'warning') {
        bgColor = 'bg-yellow-600';
        iconClass = 'fas fa-exclamation-triangle';
    } else if (type === 'success') {
        bgColor = 'bg-green-600';
        iconClass = 'fas fa-check-circle';
    } else {
        bgColor = 'bg-blue-600';
        iconClass = 'fas fa-info-circle';
    }
    
    // Create toast notification
    const toastDiv = document.createElement('div');
    toastDiv.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-5 rounded-lg shadow-2xl z-[9999] toast-notification animate-fade-in border-l-4 border-white`;
    toastDiv.innerHTML = `
        <div>
            <div class="flex items-start mb-3">
                <i class="${iconClass} text-3xl mr-4 mt-1"></i>
                <div class="flex-1">
                    <h3 class="font-bold text-lg mb-1">${title}</h3>
                    <p class="text-sm text-white/90">${message}</p>
                </div>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="ml-4 text-white/80 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="flex justify-end">
                <button id="toastActionBtn" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white font-semibold rounded transition">
                    <i class="fas fa-redo mr-2"></i>${actionLabel}
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(toastDiv);
    
    // Attach action callback
    const actionBtn = toastDiv.querySelector('#toastActionBtn');
    if (actionBtn && actionCallback) {
        actionBtn.addEventListener('click', function() {
            actionCallback();
            toastDiv.remove();
        });
    }
    
    // Don't auto-remove (let user dismiss or take action)
}

// Restart video from beginning
function restartVideo() {
    const video = document.getElementById('videoPlayer');
    video.currentTime = 0;
    resetVideoProgress();
    video.play();
    
    showSuccess('Video restarted. Watch carefully to get completion credit!');
    console.log('üîÑ Video restarted - Progress reset');
}

// Update progress display
function updateProgressDisplay() {
    const video = document.getElementById('videoPlayer');
    if (!video.duration) return;
    
    const progressPercent = (videoProgress.lastPosition / video.duration) * 100;
    document.getElementById('progressText').textContent = Math.round(progressPercent) + '%';
    document.getElementById('progressBar').style.width = progressPercent + '%';
}

// Save video progress to server
async function saveVideoProgress() {
    if (!currentMaterialId) return;
    
    const video = document.getElementById('videoPlayer');
    
    // Don't save if video hasn't loaded or duration is invalid
    if (!video.duration || isNaN(video.duration) || video.duration === 0) {
        console.log('Video not loaded properly, skipping progress save');
        return;
    }
    
    // Don't save if current time is invalid
    if (isNaN(video.currentTime)) {
        console.log('Invalid video time, skipping progress save');
        return;
    }
    
    const progressData = {
        materialId: currentMaterialId,
        lastPositionSeconds: Math.floor(video.currentTime),
        completionPercent: video.duration ? (video.currentTime / video.duration) * 100 : 0,
        timeSpentMinutes: Math.floor(videoProgress.watchTime / 60),
        isCompleted: videoProgress.isCompleted  // Use the explicit completion flag
        // suspiciousActivity: videoProgress.suspiciousActivity
    };
    
    console.log('üíæ Saving video progress:', {
        material: currentMaterialId.substring(0, 8) + '...',
        position: progressData.lastPositionSeconds + 's',
        completion: Math.round(progressData.completionPercent) + '%',
        timeSpent: progressData.timeSpentMinutes + 'min',
        isCompleted: progressData.isCompleted,
        fullData: progressData
    });
    
    try {
        // Get CSRF token from the page
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
        
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
            console.log('CSRF token found:', csrfToken.substring(0, 10) + '...');
        } else {
            console.warn('CSRF token not found on page');
        }
        
            const response = await fetch('/learner/materials/progress', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(progressData)
            });
            
            if (response.ok) {
                const responseData = await response.json();
                console.log('‚úÖ Progress saved successfully!');
                console.log('üì¶ Response:', responseData);
                
                // If material was marked as completed, show it clearly
                if (progressData.isCompleted) {
                    console.log('üéØ MATERIAL MARKED AS COMPLETED IN DATABASE!');
                    console.log('üìà Course progress should update now...');
                }
            } else {
                console.error('‚ùå Failed to save progress:', response.status);
                const errorText = await response.text();
                console.error('Error details:', errorText);
            }
    } catch (error) {
        console.error('Failed to save progress:', error);
    }
}

// Close modal when clicking outside
document.getElementById('videoPlayerModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeVideoPlayer();
    }
});

// Update enrollment progress dynamically (no page reload)
async function updateEnrollmentProgress() {
    const enrollmentId = '[[${enrollment.id}]]';
    
    try {
        console.log('üìä Fetching updated enrollment progress...');
        
        // Fetch latest enrollment data as JSON
        const response = await fetch(`/learner/enrollments/${enrollmentId}/progress`);
        if (!response.ok) {
            throw new Error('Failed to fetch enrollment data');
        }
        
        const enrollment = await response.json();
        console.log('üì¶ Received enrollment data:', enrollment);
        
        // Update progress percentage
        const progressPercent = enrollment.progressPercent || 0;
        const progressText = Math.round(progressPercent) + '%';
        
        console.log('üîç Looking for progress bar elements...');
        
        // Update progress bar
        const progressBar = document.querySelector('.progress-bar-fill');
        const progressDisplay = document.querySelector('.text-5xl.font-bold');
        
        console.log('üîç Found progress bar:', progressBar);
        console.log('üîç Found progress display:', progressDisplay);
        
        if (progressBar && progressDisplay) {
            progressBar.style.width = progressPercent + '%';
            progressDisplay.textContent = progressText;
            
            // Add smooth animation
            progressBar.classList.add('transition-all', 'duration-500');
            
            console.log('‚úÖ Progress bar updated to:', progressText);
        } else {
            console.warn('‚ö†Ô∏è Could not find progress bar elements!');
        }
        
        // Update materials count (X/Y format)
        const completedMaterials = enrollment.completedMaterials || 0;
        const totalMaterials = enrollment.totalMaterials || 0;
        
        // Find and update the materials count display
        const materialsCountElement = document.querySelector('[data-materials-count]');
        if (materialsCountElement) {
            materialsCountElement.textContent = `${completedMaterials}/${totalMaterials}`;
            console.log('‚úÖ Materials count updated to:', completedMaterials + '/' + totalMaterials);
        }
        
        // Only show completion toast if status just changed to COMPLETED
        // (We check if the current displayed progress was less than 100%)
        const currentProgressText = document.querySelector('.text-5xl.font-bold')?.textContent;
        const wasNotCompleted = currentProgressText && parseInt(currentProgressText) < 100;
        
        if (enrollment.status === 'COMPLETED' && wasNotCompleted) {
            showSuccess('üéâ Congratulations! Course completed!');
            console.log('üéâ Course marked as COMPLETED!');
        } else if (enrollment.status === 'COMPLETED') {
            console.log('‚ÑπÔ∏è Course already completed');
        }
        
        console.log('üéâ Progress updated successfully without page reload!');
        
    } catch (error) {
        console.error('‚ùå Failed to update progress:', error);
        console.log('üí° Progress will be visible on next page load');
    }
}

// DEBUG FUNCTION - Check current enrollment progress
window.checkEnrollmentProgress = async function() {
    await updateEnrollmentProgress();
};

console.log('üí° Debug helper loaded! Type checkEnrollmentProgress() in console to refresh progress');
console.log('üí° Or just watch the console logs as you complete videos!');
console.log('üí° Type resetMaterialProgress("materialId") to reset a material for testing');

// DEBUG: Reset material progress (for testing only)
window.resetMaterialProgress = async function(materialId) {
    const enrollmentId = '[[${enrollment.id}]]';
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    
    try {
        const response = await fetch('/learner/materials/progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                materialId: materialId,
                isCompleted: false,
                completionPercent: 0.0,
                timeSpentMinutes: 0,
                lastPositionSeconds: 0
            })
        });
        
        if (response.ok) {
            console.log('‚úÖ Material progress reset!');
            window.location.reload();
        } else {
            console.error('‚ùå Failed to reset progress');
        }
    } catch (error) {
        console.error('Error resetting progress:', error);
    }
};

// Load material progress on page load
async function loadMaterialProgress() {
    const enrollmentId = '[[${enrollment.id}]]';
    
    try {
        const response = await fetch(`/learner/enrollments/${enrollmentId}/materials/progress`);
        
        if (response.ok) {
            const progressData = await response.json();
            
            // Pre-check completed materials
            progressData.forEach(progress => {
                const checkbox = document.querySelector(`input[data-material-id="${progress.materialId}"]`);
                if (checkbox) {
                    // Set checkbox state based on completion
                    checkbox.checked = progress.isCompleted || false;
                }
            });
            
            console.log('‚úÖ Material progress loaded');
        }
    } catch (error) {
        console.error('Failed to load material progress:', error);
    }
}

// Load progress when page loads
loadMaterialProgress();
</script>

</div>
</body>
</html>

